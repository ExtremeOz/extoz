<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lead Intake Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
    form { max-width: 820px; }
    fieldset { border: 1px solid #ddd; padding: 16px; margin-bottom: 16px; }
    label { display: block; margin-top: 8px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .actions { margin-top: 16px; }
    pre { background: #0b1020; color: #e6f3ff; padding: 12px; overflow: auto; }
    .success { color: #0a7f3f; font-weight: 600; }
    .error { color: #b00020; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Lead Intake – Test Form</h1>

  <form id="leadForm">
    <fieldset>
      <legend>Contact</legend>
      <div class="row">
        <label>First name <input name="firstName" required /></label>
        <label>Last name <input name="lastName" required /></label>
      </div>
      <div class="row">
        <label>Email <input name="email" type="email" required /></label>
        <label>Phone (E.164) <input name="phone" placeholder="+61412345678" required /></label>
      </div>
      <label>Preferred contact method
        <select name="preferredContactMethod">
          <option value="email">Email</option>
          <option value="phone">Phone</option>
          <option value="sms">SMS</option>
        </select>
      </label>
    </fieldset>

    <fieldset>
      <legend>Inspection Address</legend>
      <label>Address line 1 <input name="address1" required /></label>
      <label>Address line 2 <input name="address2" /></label>
      <div class="row">
        <label>Suburb <input name="suburb" required /></label>
        <label>State <input name="state" placeholder="QLD" required /></label>
      </div>
      <div class="row">
        <label>Postcode <input name="postCode" pattern="\d{4}" required /></label>
        <label>Country <input name="country" value="AU" required /></label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Requested Date/Time</legend>
      <div class="row">
        <label>Date <input name="localDate" type="date" required id="d" /></label>
        <label>Time (rounded to 30 mins)<input name="localTime" type="time" step="1800" required id="t" /></label>
      </div>
      <div class="row">
        <label>Timezone ID <input name="timezoneId" value="Australia/Brisbane" required /></label>
        <label>Flexibility window (minutes) <input name="windowMinutes" type="number" min="0" value="60" /></label>
      </div>
      <label>Alternate dates (comma separated YYYY-MM-DD)
        <input name="alternateDates" placeholder="2026-02-18, 2026-02-20" />
      </label>
    </fieldset>

    <fieldset>
      <legend>Services</legend>
      <label>Choose services (hold Ctrl/Cmd to multi-select)
        <select name="services" multiple size="5">
          <option value="GEN_INSPECTION">General Inspection</option>
          <option value="SMOKE_ALARM_TEST">Smoke Alarm Test</option>
          <option value="POOL_FENCE_CHECK">Pool Fence Check</option>
          <option value="ELEC_SAFETY_CHECK">Electrical Safety Check</option>
          <option value="ASBESTOS_ASSESSMENT">Asbestos Assessment</option>
        </select>
      </label>
      <label>Notes (optional)
        <textarea name="notes" rows="3" placeholder="Anything we should know (gate code, pets, parking, etc.)"></textarea>
      </label>
    </fieldset>

    <fieldset>
      <legend>Meta</legend>
      <div class="row">
        <label>Form Id <input name="formId" value="lead-intake-v1" required /></label>
        <label>Tenant Code (optional) <input name="tenant" placeholder="cairns" /></label>
      </div>
      <label><input type="checkbox" name="privacy" required /> I accept the privacy policy</label>
      <label><input type="checkbox" name="marketing" /> I agree to receive marketing communications</label>
    </fieldset>

    <div class="actions">
      <button type="submit">Send test request</button>
    </div>
  </form>

  <h2>Request</h2>
  <pre id="req"></pre>

  <h2>Response</h2>
  <div id="status"></div>
  <pre id="res"></pre>
  <noscript>To use this site, please enable JavaScript.</noscript>
  <script>
    // Set this to your Flow endpoint URL to test direct POSTs (likely blocked by CORS),
    // or set to "/api/submit" when using the SWA proxy function below.
    // const FLOW_ENDPOINT_URL = "/api/submit"; // e.g., "https://prod-XX...logic.azure.com:443/workflows/.../triggers/manual/paths/invoke?api-version=2016-10-01&sp=...&sv=...&sig=..."
    const FLOW_ENDPOINT_URL = "https://acd06123d6dfed108b2b6f31e6923e.c5.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/d83d68207a794404ba7c0cd3509dc92f/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jOtVht8zCLjy1WHv9DyQ6WZjbzQQtn8AOxjdScp4S88";
    const form = document.getElementById('leadForm');
    const preReq = document.getElementById('req');
    const preRes = document.getElementById('res');
    const statusEl = document.getElementById('status');
    const timeInput = document.getElementById('t');
    const dateInput = document.getElementById('d');

    function roundtoNearest30Mins(timeStr) {
      const [h, m] = timeStr.split(':').map(Number);
      const roundedM = m < 15 ? '00' : m < 45 ? '30' : '00';
      const roundedH = m >= 45 ? (h + 1) % 24 : h;
      return `${roundedH.toString().padStart(2,'0')}:${roundedM}`;
    }
    function uuidv4() {
      // browsers with crypto support
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      // fallback
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    dateInput.value = new Date().toISOString().slice(0,10); // default to current date
    const roundedTime = roundtoNearest30Mins(new Date().toISOString().slice(11,16)); // default to current time
    timeInput.step = 1800; // enforce 30 min steps in browsers that support it
    timeInput.value = roundedTime; // used for display only; we re-round on change to ensure valid times even if user types manually


    timeInput.addEventListener('change', () => {
      // Round to nearest 30 mins
      const [h, m] = timeInput.value.split(':').map(Number);
      const roundedM = m < 15 ? '00' : m < 45 ? '30' : '00';
      const roundedH = m >= 45 ? (h + 1) % 24 : h;
      timeInput.value = `${roundedH.toString().padStart(2,'0')}:${roundedM}`;
    }); 

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      preRes.textContent = '';

      const fd = new FormData(form);
      const altDatesRaw = (fd.get('alternateDates') || '').toString().trim();
      const alternateDates = altDatesRaw
        ? altDatesRaw.split(',').map(s => s.trim()).filter(Boolean)
        : [];

      // Multi-select services => array of { code, quantity: 1 }
      const services = Array.from(form.elements['services'].selectedOptions)
        .map(opt => ({ code: opt.value, quantity: 1 }));

      const payload = {
        formId: fd.get('formId') || 'lead-intake-v1',
        idempotencyKey: uuidv4(),
        tenantCode: (fd.get('tenantCode') || '').trim() || undefined,
        contact: {
          firstName: fd.get('firstName'),
          lastName: fd.get('lastName'),
          email: (fd.get('email') || '').toString().trim().toLowerCase(),
          phone: (fd.get('phone') || '').toString().trim(),
          preferredContactMethod: fd.get('preferredContactMethod') || 'email'
        },
        inspectionAddress: {
          address1: fd.get('address1'),
          address2: fd.get('address2') || '',
          suburb: fd.get('suburb'),
          state: fd.get('state'),
          postCode: fd.get('postCode'),
          country: fd.get('country') || 'AU'
        },
        requestedSlot: {
          localDate: fd.get('localDate'),
          localTime: fd.get('localTime'),
          timezoneId: fd.get('timezoneId') || 'Australia/Brisbane',
          windowMinutes: Number(fd.get('windowMinutes') || 0),
          alternateDates
        },
        services,
        notes: fd.get('notes') || '',
        consent: {
          privacyPolicyAccepted: form.elements['privacy'].checked,
          marketingOptIn: form.elements['marketing'].checked
        },
        // For testing, we capture basic metadata
        metadata: {
          userAgent: navigator.userAgent,
          referrer: document.referrer
        }
      };

      // Clean undefined/null fields for readability
      const clean = JSON.parse(JSON.stringify(payload));
      preReq.textContent = JSON.stringify(clean, null, 2);
      
      try {
        const res = await fetch(FLOW_ENDPOINT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Optional: pass idempotency & tenant in headers too (nice for flow filtering)
            'x-idempotency-key': clean.idempotencyKey,
            ...(clean.tenantCode ? { 'x-tenant-code': clean.tenantCode } : {})
            // Do NOT compute HMAC here; keep secrets server-side.
          },
          body: JSON.stringify(clean)
        });

        const text = await res.text();
        statusEl.textContent = res.ok ? `✔ ${res.status} ${res.statusText}` : `✖ ${res.status} ${res.statusText}`;
        statusEl.className = res.ok ? 'success' : 'error';
        preRes.textContent = text;
      } catch (err) {
        statusEl.textContent = '✖ Network error';
        statusEl.className = 'error';
        preRes.textContent = String(err);
      }
    });
  </script>
</body>
</html>